pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
	poke(0x5f5c, 255) -- disable auto-repeat
	poke(0x5f5d, 255)
	cls(0)
	music(0)
	spd=18
	bpm=1800/spd
	maxpulse=360
	pulse=360
	last_row = -1
	timing = -1
	-- 2 good, 1 ok, 0 bad, -1 nothing
	
	lastInput = 0
end

function _update60()
	if btnp(⬆️) then
		spd -= 1
		setspd(spd)
	end
	if btnp(⬇️) then
		spd += 1
		setspd(spd)
	end
	
	timing = -1
	timing = checktiming()

	local row = stat(21)
	if row != last_row then
		if row % 4 == 0 then
	    	pulse = maxpulse
	    	sfx(3)
	  	end
	  	last_row = row
	end
 
	if pulse>0 then
		pulse -= 10 * (bpm/100)
		pulse = max(pulse, 0)
	end
end

function _draw()
	cls()
	--camera(px - 64, py - 64)
	print("⬆️ and ⬇️ to change tempo")
	print(bpm)
	print(pulse)
	print("row: "..stat(21))
	print(lastInput)
	circfill(64, 64, 7 + 21*pulse/maxpulse, 1)

end
-->8
function setsfxspeed(id, speed)
  local sfx_base = 0x3200
  local sfx_size = 68

  if id < 0 or id > 63 then return end
  local addr = sfx_base + id * sfx_size + 65
  poke(addr, speed)
end

function setspd(spd)
	music(-1)
	setsfxspeed(0,spd)
	setsfxspeed(2,spd)
	bpm = 1800/spd
	music(0)
end

-->8

function checktiming()
	local buffer = 2/10
	if btnp(❎) then
		lastInput = pulse
		if pulse > (1 - buffer) * maxpulse or pulse < buffer * maxpulse then
			timing = 2
			pcol = 11
		elseif pulse > (1 - 2 * buffer) * maxpulse or pulse < 2 * buffer * maxpulse then
			timing = 1
			pcol = 10
		else
			timing = 0
			pcol = 8
		end
	end
	return timing
end


__gfx__
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700777777070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000777707770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000707777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700700000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
911200000b633006003c6000b63330615006050b6330b6000b6000b6000b6333060030615006000b600306000b633006003c6000b63330615006050b633306000b600306000b6333060030615000003060000000
010f0000070500705013050130501205012000100501005010050100500e0500e0500c0500c0500e0500e0500b0500b05013050130501205012000100501005010050100500b0500b05009050090500b0500b050
0112000007070000000700007070070000000007070000000600000000060700000007070000000907000000070700000000000070700000000000060700000000000000000c070000000b070000000907000000
000400003c11015100001001710017100121001210000100101001010000100001000010010100101000010012100121000010013100131000e1000e100001000c1000c100001000010000100001000010000100
00030000145500f5400c5400853003520015100051000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500
01010000077500b7500f750157501a7501e750207502575027750287502a7502c7502d7502d7502e7002e7002d7002b7002a7002a7002a7002a7002a7002b7002b70000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010000011700137001570017700287002a7002b7002570026700267002770028700297002a7002d7002b7002d7002f7002e70032700317003470033700347003570036700367003670036700000000000000000
__music__
02 00024344

